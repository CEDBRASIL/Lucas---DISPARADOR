<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPH - DISPAROS</title>
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* CSS Reset and Base Styles */
        :root {
            --bg-color: #1b1c1d;
            --sidebar-color: #16161a;
            --card-bg: #242529;
            --primary-color: #9f7aea;
            --primary-hover: #b392f0;
            --text-color: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: #3a3b40;
            --success-color: #28a745;
            --danger-color: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-color);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transition: width 0.3s ease;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .sidebar-header h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.6rem;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            letter-spacing: 0.5px;
        }

        .sidebar-header h1 .logo-highlight {
            color: var(--primary-color);
        }

        .sidebar-header p {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: 1px;
        }

        .sidebar nav ul {
            list-style: none;
        }

        .sidebar nav ul li a {
            display: flex;
            align-items: center;
            padding: 1rem;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sidebar nav ul li a i {
            margin-right: 1rem;
            width: 20px;
            text-align: center;
            transition: color 0.3s ease;
        }

        .sidebar nav ul li a:hover {
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .sidebar nav ul li a.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(159, 122, 234, 0.2);
        }
        
        .sidebar nav ul li a.active i {
            color: white;
        }

        .footer {
            margin-top: auto;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .footer a {
            color: var(--primary-color);
            text-decoration: none;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header h2 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        
        .warning-banner {
            background-color: rgba(220, 53, 69, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
        }
        .warning-banner strong {
            font-weight: 600;
        }

        /* General Components */
        .card {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(159, 122, 234, 0.3);
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 5px;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        .btn-danger:hover {
            background-color: #e44d5c;
        }

        .btn-secondary {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .btn-secondary:hover {
            background-color: var(--border-color);
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        .btn-icon:hover {
            background-color: var(--border-color);
            color: var(--danger-color);
        }
        
        /* Conectar Page */
        .connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .connection-card {
            background: none;
            border: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .connection-card:hover {
            transform: none;
            box-shadow: none;
        }

        .connection-card .status {
            font-size: 0.9rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .connection-card .status.disconnected {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }

        .connection-card .status.connected {
             background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }
        
        .connection-card .status.loading {
             background-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .qr-placeholder {
            width: 200px;
            height: 200px;
            background-color: #fff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1rem 0;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .qr-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .qr-placeholder iframe {
            width: 500px;
            height: 500px;
            border: 0;
            /* Ampliado para preencher melhor a caixa do QR */
            transform: scale(0.72);
            transform-origin: top left;
            position: absolute;
            top: 0;
            left: 0;
        }

        .connection-card input {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            margin-bottom: 1rem;
            text-align: center;
        }

        .connection-card .status,
        .connection-card input,
        .connection-card .info-text,
        .connection-card .connect-btn {
            display: none;
        }

        /* Gerador de Leads Page */
        .lead-gen-container .card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .results-table {
            margin-top: 1.5rem;
            display: none; /* Initially hidden */
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead th {
            background-color: var(--card-bg);
            padding: 0.75rem 1rem;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--border-color);
        }
        
        tbody tr:last-child {
            border-bottom: none;
        }

        tbody td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
        }

        tbody tr:hover {
            background-color: var(--border-color);
        }
        
        .admin-badge {
            background-color: rgba(159, 122, 234, 0.2);
            color: var(--primary-color);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Disparo Page */
        .campaigns-list {
            margin-top: 1.5rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .campaign-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-bg);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
        }
        
        .campaign-info p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        .campaign-info strong {
            color: var(--text-color);
            font-weight: 500;
        }
        
        .campaign-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 500;
        }
        .status-badge.sending {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        .status-badge.completed {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 2rem;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes slideIn {
             from { transform: translateY(-50px); opacity: 0; }
             to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-content.small {
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .close-btn {
            color: var(--text-muted);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-btn:hover {
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
        }
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Campaign Modal Specifics */
        .campaign-form-layout {
            display: flex;
            gap: 2rem;
        }
        .campaign-form-main {
            flex: 2;
        }
        .campaign-form-aside {
            flex: 1;
        }
        .tip-box {
            background-color: var(--bg-color);
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
            font-size: 0.9rem;
        }
        .tip-box h4 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        .message-variation {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .message-variation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .variable-buttons button {
            background-color: var(--border-color);
            border: none;
            color: var(--text-color);
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 2px;
            font-size: 0.8rem;
        }
        
        /* Import Modal Specifics */
        .column-mapping-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
            justify-content: space-between;
        }
        .column-mapping-row select {
            flex-grow: 1;
        }

    </style>
</head>
<body>
    
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>
                <span class="logo-highlight">&lt;</span><span class="logo-highlight">/&gt;</span>
            </h1>
            <p>Disparos</p>
        </div>
        <nav>
            <ul>
                <li><a href="#" class="nav-link active" data-target="conectar"><i class="fa-solid fa-qrcode"></i> Conectar</a></li>
                <li><a href="#" class="nav-link" data-target="gerador"><i class="fa-solid fa-users"></i> Gerador de Leads</a></li>
                <li><a href="#" class="nav-link" data-target="disparo"><i class="fa-solid fa-paper-plane"></i> Disparo</a></li>
            </ul>
        </nav>
        <div class="footer">
            <p>Feito com amor e carinho por<br>Encrypthost &reg; <br> <a href="https://www.encrypthost.com.br" target="_blank">www.encrypthost.com.br</a></p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="warning-banner">
            <p><strong>Nenhuma informação será salva para sempre, as informações como Campanhas serão salvas somente com Cache (Cookies do Navegador).</strong></p>
        </div>
    
        <!-- Page: Conectar -->
        <section id="conectar" class="page active">
            <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;">
                <h2>Conectar Números</h2>
                <button class="btn" id="openLocalConnectBtn"><i class="fa-solid fa-qrcode"></i> Conectar Local</button>
            </div>
            <div class="connections-grid">
                <!-- Connection Cards will be populated by JS -->
                <div class="connection-card" data-instance="1"></div>
                <div class="connection-card" data-instance="2"></div>
                <div class="connection-card" data-instance="3"></div>
            </div>
        </section>

        <!-- Page: Gerador de Leads -->
        <section id="gerador" class="page">
            <div class="page-header">
                <h2>Gerador de Leads</h2>
            </div>
            <div class="lead-gen-container">
                <h3>Extrair Contatos de Grupos</h3>
                <p>Selecione um grupo para extrair os contatos.</p>
                <button class="btn" id="selectGroupBtn"><i class="fa-solid fa-list-check"></i> Selecionar Grupo</button>
                
                <div class="results-table card">
                    <div class="results-header">
                        <h3>Contatos Extraídos</h3>
                        <button class="btn btn-sm btn-danger" id="removeSelectedBtn" style="display: none;"><i class="fa-solid fa-trash-can"></i> Remover Selecionados</button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllCheckbox"></th>
                                    <th>Número</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="contactsList"></tbody>
                        </table>
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                        <button class="btn btn-secondary"><i class="fa-solid fa-file-csv"></i> Exportar CSV</button>
                        <button class="btn btn-secondary"><i class="fa-solid fa-file-excel"></i> Exportar XLSX</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Page: Disparo -->
        <section id="disparo" class="page">
            <div class="page-header">
                <h2>Campanhas de Disparo</h2>
            </div>
            <div class="card">
                <button class="btn" id="createCampaignBtn"><i class="fa-solid fa-plus"></i> Criar Nova Campanha</button>
            </div>
            <div class="campaigns-list" id="campaignsList">
                 <p id="noCampaignsMsg">Nenhuma campanha criada ainda. Clique no botão acima para começar.</p>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div id="groupSelectorModal" class="modal">
        <div class="modal-content small">
            <div class="modal-header"><h3>Selecione um Grupo</h3><span class="close-btn">&times;</span></div>
            <div class="modal-body">
                <p>Selecione de qual número conectado você deseja ver os grupos:</p>
                <select id="group-instance-selector" class="form-group" style="width: 100%; padding: 0.5rem;"></select>
                <hr style="border-color: var(--border-color); margin: 1rem 0;">
                <div id="groupsListContainer"><p>Conecte um número primeiro.</p></div>
            </div>
        </div>
    </div>

    <div id="campaignModal" class="modal">
        <div class="modal-content">
             <div class="modal-header"><h3>Nova Campanha</h3><span class="close-btn">&times;</span></div>
             <div class="modal-body">
                <form id="campaignForm">
                    <div class="campaign-form-layout">
                        <div class="campaign-form-main">
                            <div class="form-group"><label for="campaignName">Nome da Campanha</label><input type="text" id="campaignName" required></div>
                            <div class="form-group"><label for="chipSelector">Disparar com o Chip:</label><select id="chipSelector" required></select></div>
                            <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                            
                            <div id="messageVariationsContainer">
                                <!-- JS will populate this -->
                            </div>
                            <button type="button" class="btn btn-secondary" id="addVariationBtn"><i class="fa-solid fa-plus"></i> Adicionar Variação</button>
                            
                            <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <label for="contacts">Lista de Números</label>
                                    <button type="button" class="btn btn-sm btn-secondary" id="importContactsBtn"><i class="fa-solid fa-upload"></i> Importar Contatos</button>
                                    <input type="file" id="contactFileInput" style="display: none;" accept=".csv, .xlsx">
                                </div>
                                <textarea id="contacts" placeholder="55119...&#10;55219...&#10;55319..." required></textarea>
                            </div>
                        </div>
                        <div class="campaign-form-aside">
                            <div class="tip-box">
                                <h4><i class="fa-solid fa-lightbulb"></i> Dica de Ouro</h4>
                                <p>Use variações de mensagens e as variáveis para tornar cada envio único. Isso melhora a entrega e evita bloqueios!</p>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label>Variáveis</label>
                                <div class="variable-buttons">
                                    <button type="button" class="variable-btn">{{NOME}}</button>
                                    <button type="button" class="variable-btn">{{NUMERO}}</button>
                                    <button type="button" class="variable-btn">{{DESCRIÇÃO 1}}</button>
                                    <button type="button" class="variable-btn">{{DESCRIÇÃO 2}}</button>
                                    <button type="button" class="variable-btn">{{DESCRIÇÃO 3}}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right; margin-top: 2rem;">
                        <button type="submit" class="btn"><i class="fa-solid fa-rocket"></i> Iniciar Disparo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="localConnectModal" class="modal">
        <div class="modal-content small">
            <div class="modal-header"><h3>Conectar</h3><span class="close-btn" id="closeLocalConnect">&times;</span></div>
            <div class="modal-body" style="text-align:center;">
                <iframe id="localConnectFrame" src="/connect" style="width:100%;height:400px;border:none;"></iframe>
            </div>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content small">
            <div class="modal-header"><h3>Mapear Colunas</h3><span class="close-btn">&times;</span></div>
            <div class="modal-body">
                <p>Selecione a coluna do seu arquivo que corresponde a cada campo.</p>
                <div id="columnMapping" style="margin-top: 1rem;">
                    <!-- JS will populate this -->
                </div>
                 <div style="text-align: right; margin-top: 2rem;">
                    <button id="confirmImportBtn" type="button" class="btn"><i class="fa-solid fa-check"></i> Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Cache (localStorage) Initialization ---
        const APP_PREFIX = 'EPH_DISPAROS_';
        const BASE_URLS = {
            '1': 'https://whatsapp-api-uylw.onrender.com',
            '2': 'https://wha-api-lucas-2.onrender.com',
            '3': 'https://wha-api-lucas-3.onrender.com'
        };
        let connections = JSON.parse(localStorage.getItem(APP_PREFIX + 'connections')) || {
            '1': { connected: false, name: '' }, '2': { connected: false, name: '' }, '3': { connected: false, name: '' }
        };
        const statusIntervals = {};
        const qrIntervals = {};
        let campaigns = JSON.parse(localStorage.getItem(APP_PREFIX + 'campaigns')) || [];

        // --- UI Elements ---
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const allModals = document.querySelectorAll('.modal');
        
        const groupModal = document.getElementById('groupSelectorModal');
        const campaignModal = document.getElementById('campaignModal');
        const importModal = document.getElementById('importModal');
        const openLocalConnectBtn = document.getElementById('openLocalConnectBtn');
        const localConnectModal = document.getElementById('localConnectModal');
        const localConnectFrame = document.getElementById('localConnectFrame');
        const selectGroupBtn = document.getElementById('selectGroupBtn');

        const createCampaignBtn = document.getElementById('createCampaignBtn');
        const campaignForm = document.getElementById('campaignForm');
        const addVariationBtn = document.getElementById('addVariationBtn');
        const variationsContainer = document.getElementById('messageVariationsContainer');
        let activeTextarea = null;

        const importContactsBtn = document.getElementById('importContactsBtn');
        const contactFileInput = document.getElementById('contactFileInput');
        
        const contactsListBody = document.getElementById('contactsList');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const removeSelectedBtn = document.getElementById('removeSelectedBtn');

        // --- Functions ---
        const saveState = () => {
            localStorage.setItem(APP_PREFIX + 'connections', JSON.stringify(connections));
            localStorage.setItem(APP_PREFIX + 'campaigns', JSON.stringify(campaigns));
        };

        const switchPage = (targetId) => {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
            navLinks.forEach(link => link.classList.toggle('active', link.dataset.target === targetId));
        };

        const PROXY_BASE = 'http://localhost:8000/proxy?url=';

        const startStatusMonitor = (instanceId) => {
            if (statusIntervals[instanceId]) return;
            const baseUrl = BASE_URLS[instanceId];
            statusIntervals[instanceId] = setInterval(async () => {
                let isConnected = false;
                try {
                    const r = await fetch(PROXY_BASE + encodeURIComponent(baseUrl + '/connect'));
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    const txt = await r.text();
                    isConnected = txt.toLowerCase().includes('conectado com sucesso');
                } catch (e) {
                    isConnected = false;
                    const card = document.querySelector(`.connection-card[data-instance='${instanceId}']`);
                    if (card) {
                        card.querySelector('.status').textContent = 'Erro de conexão (proxy offline?)';
                    }
                }
                if (connections[instanceId].connected !== isConnected) {
                    connections[instanceId].connected = isConnected;
                    saveState();
                    renderConnectionCard(instanceId);
                }
                if (isConnected && qrIntervals[instanceId]) {
                    clearInterval(qrIntervals[instanceId]);
                    delete qrIntervals[instanceId];
                }
            }, 1000);
        };
        const renderConnectionCard = (instanceId) => {
            const card = document.querySelector(`.connection-card[data-instance='${instanceId}']`);
            if (!card) return;
            
            const connection = connections[instanceId];
            let statusClass = connection.connected ? 'connected' : 'disconnected';
            let statusText = connection.connected ? 'Conectado!' : 'Desconectado';
            
            card.innerHTML = `
                <span class="status ${statusClass}">${statusText}</span>
                <input type="text" placeholder="Nome do Chip (ex: Vendas 1)" class="instance-name" value="${connection.name || ''}">
                <div class="qr-placeholder">
                    ${connection.connected 
                        ? `<i class="fa-solid fa-check-circle" style="color: var(--success-color); font-size: 80px;"></i>` 
                        : `<p class="qr-text">Clique em Conectar</p>`
                    }
                </div>
                <div class="info-text">
                    ${connection.connected 
                        ? `<p>Conectado como <strong>${connection.name || `Chip ${instanceId}`}</strong></p>` 
                        : `<p>Conecte para iniciar</p>`
                    }
                </div>
                <button class="btn connect-btn ${connection.connected ? 'btn-secondary' : ''}">
                    <i class="fa-solid ${connection.connected ? 'fa-power-off' : 'fa-brands fa-whatsapp'}"></i> ${connection.connected ? 'Desconectar' : 'Conectar'}
                </button>
            `;
            
            card.querySelector('.connect-btn').addEventListener('click', () => handleConnect(instanceId));
            card.querySelector('.instance-name').addEventListener('change', (e) => {
                connections[instanceId].name = e.target.value;
                saveState();
                if(connections[instanceId].connected) renderConnectionCard(instanceId);
            });
        };

        const handleConnect = (instanceId, forceConnect = false) => {
            const baseUrl = BASE_URLS[instanceId];
            if (connections[instanceId].connected && !forceConnect) {
                connections[instanceId].connected = false;
                saveState();
                renderConnectionCard(instanceId);
                if (qrIntervals[instanceId]) {
                    clearInterval(qrIntervals[instanceId]);
                    delete qrIntervals[instanceId];
                }
            } else {
                const card = document.querySelector(`.connection-card[data-instance='${instanceId}']`);
                const statusEl = card.querySelector('.status');
                const qrPlaceholder = card.querySelector('.qr-placeholder');

                statusEl.className = 'status loading';
                statusEl.textContent = 'Gerando QR Code...';
                qrPlaceholder.innerHTML = `<i class="fa-solid fa-spinner fa-spin" style="font-size: 50px; color: var(--primary-color);"></i>`;

                fetch(baseUrl + '/connect', { method: 'POST', mode: 'no-cors' }).catch(() => {});

                setTimeout(() => {
                    qrPlaceholder.innerHTML = `<iframe src="${baseUrl}/connect"></iframe>`;
                    statusEl.textContent = 'Aguardando leitura...';
                    qrIntervals[instanceId] = setInterval(() => {
                        const iframe = qrPlaceholder.querySelector('iframe');
                        if (iframe) {
                            iframe.src = `${baseUrl}/connect?${Date.now()}`;
                        }
                    }, 1000);
                }, 1000);

                startStatusMonitor(instanceId);
            }
        };

        const renderCampaigns = () => {
            const listEl = document.getElementById('campaignsList');
            const noCampaignsMsg = document.getElementById('noCampaignsMsg');
            listEl.innerHTML = '';
            
            if (campaigns.length === 0) {
                noCampaignsMsg.style.display = 'block';
            } else {
                noCampaignsMsg.style.display = 'none';
                campaigns.forEach(campaign => {
                    const card = document.createElement('div');
                    card.className = 'campaign-card';
                    card.innerHTML = `
                        <div class="campaign-info">
                            <h4>${campaign.name}</h4>
                            <p>Chip: <strong>${campaign.chipName}</strong> | Contatos: <strong>${campaign.contactsCount}</strong> | Variações: <strong>${campaign.messages.length}</strong></p>
                        </div>
                        <div class="campaign-status">
                            <span class="status-badge ${campaign.status}">${campaign.status === 'sending' ? 'Enviando...' : 'Concluído'}</span>
                        </div>`;
                    listEl.appendChild(card);
                });
            }
        };
        
        const openModal = (modalEl) => modalEl.style.display = 'flex';
        const closeModal = (modalEl) => modalEl.style.display = 'none';

        const addMessageVariation = () => {
            const variationCount = variationsContainer.children.length;
            const newVariation = document.createElement('div');
            newVariation.className = 'message-variation';
            newVariation.innerHTML = `
                <div class="message-variation-header">
                    <strong>Variação ${variationCount + 1}</strong>
                    <button type="button" class="btn btn-sm btn-danger remove-variation-btn"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div class="form-group">
                    <textarea class="message-input" placeholder="Digite sua mensagem ou cole o link de uma imagem..."></textarea>
                </div>
            `;
            variationsContainer.appendChild(newVariation);
            newVariation.querySelector('.remove-variation-btn').addEventListener('click', () => newVariation.remove());
            newVariation.querySelector('textarea').addEventListener('focus', (e) => activeTextarea = e.target);
        };
        
        // --- Initial Setup ---
        switchPage('conectar');
        Object.keys(connections).forEach(id => {
            renderConnectionCard(id);
            startStatusMonitor(id);
            handleConnect(id, true);
        });
        renderCampaigns();

        // --- Event Listeners ---
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                switchPage(e.currentTarget.dataset.target);
            });
        });

        allModals.forEach(modal => {
            modal.querySelector('.close-btn').addEventListener('click', () => closeModal(modal));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(modal);
            });
        });

        openLocalConnectBtn.addEventListener('click', () => {
            localConnectFrame.src = '/connect';
            openModal(localConnectModal);
        });
        
        // Gerador de Leads Logic
        selectGroupBtn.addEventListener('click', () => {
            const selector = document.getElementById('group-instance-selector');
            const groupsContainer = document.getElementById('groupsListContainer');
            selector.innerHTML = '';
            groupsContainer.innerHTML = '';

            const connectedChips = Object.entries(connections).filter(([id, data]) => data.connected);

            if (connectedChips.length === 0) {
                 groupsContainer.innerHTML = '<p>Nenhum número conectado para carregar os grupos.</p>';
            } else {
                connectedChips.forEach(([id, data]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = data.name || `Chip ${id}`;
                    selector.appendChild(option);
                });
                loadGroupsFromApi();
            }

            selector.onchange = loadGroupsFromApi;
            openModal(groupModal);
        });

        function loadGroupsFromApi() {
            const instanceId = document.getElementById('group-instance-selector').value;
            const baseUrl = BASE_URLS[instanceId];
            const groupsContainer = document.getElementById('groupsListContainer');
            groupsContainer.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Carregando grupos...';

            fetch(baseUrl + '/grupos')
                .then(r => r.json())
                .then(grupos => {
                    if (!Array.isArray(grupos) || grupos.length === 0) {
                        groupsContainer.innerHTML = '<p>Nenhum grupo encontrado.</p>';
                        return;
                    }
                    groupsContainer.innerHTML = '<ul style="list-style:none; padding:0;"></ul>';
                    const ul = groupsContainer.querySelector('ul');
                    grupos.forEach(g => {
                        const li = document.createElement('li');
                        li.className = 'group-item';
                        li.textContent = g.nome || g.subject || g.id;
                        li.style.cssText = 'padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s;';
                        li.onmouseover = () => li.style.backgroundColor = 'var(--bg-color)';
                        li.onmouseout = () => li.style.backgroundColor = 'transparent';
                        li.onclick = () => selectGroup(li.textContent);
                        ul.appendChild(li);
                    });
                })
                .catch(() => {
                    groupsContainer.innerHTML = '<p>Erro ao carregar grupos.</p>';
                });
        }

        function selectGroup(groupName) {
            const instanceId = document.getElementById('group-instance-selector').value;
            const baseUrl = BASE_URLS[instanceId];
            contactsListBody.innerHTML = '';
            document.querySelector('.results-table').style.display = 'block';
            fetch(baseUrl + '/grupos/' + encodeURIComponent(groupName))
                .then(r => r.json())
                .then(data => {
                    data.participantes.forEach(p => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="checkbox" class="contact-checkbox"></td>
                            <td>${p.numero}</td>
                            <td>${p.admin ? '<span class="admin-badge">Admin</span>' : '-'}</td>
                            <td><button class="btn-icon remove-contact-btn"><i class="fa-solid fa-trash-can"></i></button></td>
                        `;
                        contactsListBody.appendChild(row);
                    });
                    updateSelectionState();
                    closeModal(groupModal);
                })
                .catch(() => {
                    contactsListBody.innerHTML = '<tr><td colspan="4">Erro ao obter participantes.</td></tr>';
                    updateSelectionState();
                });
        }

        function updateSelectionState() {
            const checkboxes = contactsListBody.querySelectorAll('.contact-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            removeSelectedBtn.style.display = checkedCount > 0 ? 'inline-flex' : 'none';
            
            const allChecked = checkboxes.length > 0 && checkedCount === checkboxes.length;
            selectAllCheckbox.checked = allChecked;
        }

        contactsListBody.addEventListener('click', (e) => {
            // Individual remove button
            if (e.target.closest('.remove-contact-btn')) {
                e.target.closest('tr').remove();
                updateSelectionState();
            }
            // Checkbox click
            if (e.target.classList.contains('contact-checkbox')) {
                updateSelectionState();
            }
        });

        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            contactsListBody.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = isChecked);
            updateSelectionState();
        });
        
        removeSelectedBtn.addEventListener('click', () => {
            contactsListBody.querySelectorAll('.contact-checkbox:checked').forEach(cb => {
                cb.closest('tr').remove();
            });
            updateSelectionState();
        });


        // Campaign Modal Logic
        createCampaignBtn.addEventListener('click', () => {
            const selector = document.getElementById('chipSelector');
            selector.innerHTML = '';
            const connectedChips = Object.entries(connections).filter(([id, data]) => data.connected);
            
            if (connectedChips.length === 0) {
                selector.innerHTML = '<option disabled>Nenhum chip conectado</option>';
            } else {
                connectedChips.forEach(([id, data]) => {
                    selector.innerHTML += `<option value="${id}">${data.name || `Chip ${id}`}</option>`;
                });
            }
            
            campaignForm.reset();
            variationsContainer.innerHTML = '';
            addMessageVariation();
            openModal(campaignModal);
        });

        addVariationBtn.addEventListener('click', addMessageVariation);

        document.querySelectorAll('.variable-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (activeTextarea) {
                    const start = activeTextarea.selectionStart;
                    const end = activeTextarea.selectionEnd;
                    const text = activeTextarea.value;
                    activeTextarea.value = text.substring(0, start) + btn.textContent + text.substring(end);
                    activeTextarea.focus();
                    activeTextarea.selectionEnd = start + btn.textContent.length;
                }
            });
        });

        campaignForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const selectedChipId = document.getElementById('chipSelector').value;
            if (!selectedChipId) { alert('Por favor, conecte um chip primeiro.'); return; }

            const messages = Array.from(variationsContainer.querySelectorAll('.message-input')).map(input => input.value).filter(val => val.trim() !== '');
            if (messages.length === 0) { alert('Adicione pelo menos uma variação de mensagem.'); return; }
            
            const newCampaign = {
                id: Date.now(),
                name: document.getElementById('campaignName').value,
                chipId: selectedChipId,
                chipName: connections[selectedChipId].name || `Chip ${selectedChipId}`,
                messages: messages,
                contactsCount: document.getElementById('contacts').value.split('\n').filter(n => n.trim() !== '').length,
                status: 'completed', // Simplified for demo
            };
            
            campaigns.push(newCampaign);
            saveState();
            renderCampaigns();
            closeModal(campaignModal);
        });
        
        // Import Logic
        importContactsBtn.addEventListener('click', () => contactFileInput.click());
        
        contactFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const simulatedColumns = ['Coluna A', 'Coluna B', 'Coluna C', 'Coluna D'];
                const mappingContainer = document.getElementById('columnMapping');
                mappingContainer.innerHTML = '';
                
                const fields = {'Número': 'numero', 'Nome': 'nome', 'Descrição 1': 'desc1', 'Descrição 2': 'desc2', 'Descrição 3': 'desc3'};

                Object.entries(fields).forEach(([label, value]) => {
                    const isRequired = label === 'Número';
                    let options = '<option value="">-- Ignorar --</option>';
                    simulatedColumns.forEach((col, index) => {
                        options += `<option value="${index}">${col}</option>`;
                    });

                    mappingContainer.innerHTML += `
                        <div class="column-mapping-row">
                            <label for="map-${value}">${label} ${isRequired ? '*' : ''}</label>
                            <select id="map-${value}" data-field="${value}">${options}</select>
                        </div>`;
                });
                
                openModal(importModal);
                e.target.value = '';
            }
        });

        document.getElementById('confirmImportBtn').addEventListener('click', () => {
            const numberColumnIndex = document.getElementById('map-numero').value;
            if (numberColumnIndex === '') {
                alert('Você deve selecionar uma coluna para os números.');
                return;
            }

            let contactsText = '';
            for (let i = 0; i < 20; i++) {
                contactsText += `55${Math.floor(10 + Math.random() * 90)}9${Math.floor(10000000 + Math.random() * 90000000)}\n`;
            }
            document.getElementById('contacts').value = contactsText;
            
            closeModal(importModal);
        });

    });
    </script>
</body>
</html>
